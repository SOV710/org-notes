#+title: Doom Emacs Evil Mode Keybindings Reference
#+author: SOV710
#+date: 2025-12-21
#+startup: showall
#+options: toc:2 num:nil

* 什么是 Doom Emacs 和 Evil Mode

** Doom Emacs: Emacs 配置框架

Doom Emacs 是一个现代化的 Emacs 配置框架，由 Henrik Lissner 创建并维护。它的核心理念是:

- *开箱即用*: 提供合理的默认配置，无需从零开始配置 Emacs
- *以 Evil 为中心*: 深度集成 Vim 风格的模态编辑
- *模块化*: 通过 =init.el= 中的模块系统按需启用功能
- *高性能*: 延迟加载、编译优化、启动速度快 (通常 <1 秒)

#+begin_quote
"An Emacs framework for the stubborn martian hacker."
— Doom Emacs 官方标语
#+end_quote

** Evil Mode: Vim 的 Emacs 实现

Evil (Extensible VI Layer for Emacs) 是一个在 Emacs 中模拟 Vim 编辑器的包。它提供了:

- *模态编辑*: Normal, Insert, Visual, Operator-pending 等 Vim 状态
- *Vim 命令*: =d=, =y=, =c=, =p=, =f=, =t=, =/=, =:= 等核心命令
- *Text Objects*: =iw= (inner word), =ap= (a paragraph), =it= (inner tag) 等
- *寄存器系统*: ="ayy=, ="ap= 等操作
- *宏录制*: =q= + 寄存器名

Evil 不是简单的键位绑定模拟，而是在 Emacs Lisp 层面实现了 Vim 的编辑语义。这意味着你可以:

- 在 Vim 模式下使用 Emacs 的所有功能 (LSP, Magit, Org-mode...)
- 通过 Emacs Lisp 扩展 Vim 命令
- 与 Emacs 生态无缝集成

** Leader Key: SPC 的魔力

Doom Emacs 使用 *Space (空格)* 作为 *Leader Key*​，这是从 Spacemacs 借鉴的设计。

在 Normal 或 Visual 模式下，按下 =SPC= 后会触发一个 *可发现的命令树*:

- =SPC f=: File 操作 (find, save, recent...)
- =SPC b=: Buffer 操作 (switch, kill, save...)
- =SPC w=: Window 操作 (split, delete, navigate...)
- =SPC p=: Project 操作 (find file, grep, compile...)
- =SPC g=: Git 操作 (status, blame, time-machine...)
- =SPC h=: Help 操作 (describe function, variable, key...)

按下 =SPC= 后稍等片刻，会弹出 =which-key= 界面，显示所有可用的后续按键和对应功能。

* Buffer: Emacs 中的文本容器

** Buffer 的本质

在 Emacs 中，*Buffer* 是文本编辑的核心概念。根据 GNU Emacs 手册:

#+begin_quote
A buffer is a Lisp object containing text to be edited. Buffers are used to hold the contents of files that are being visited; there may also be buffers that are not visiting files.
#+end_quote

Buffer 不仅仅是 "打开的文件"，而是一个 *文本容器*:

- 可以关联文件 (visiting a file)，也可以不关联 (如 =*scratch*= buffer)
- 可以在多个 window 中同时显示同一个 buffer
- 每个 buffer 有独立的 major mode, minor modes, local variables
- Buffer 的内容可以是文本、图片、甚至是进程的输出 (如 shell, compilation)

** Buffer vs. Window vs. Frame

新手常混淆这三个概念。正确的理解是:

| 概念   | 含义                            | 类比          |
|--------+---------------------------------+---------------|
| Buffer | 文本数据，不一定可见                | 内存中的文档    |
| Window | Buffer 的视图，显示 buffer 的一部分 | 屏幕上的窗格    |
| Frame  | Emacs 的顶层窗口 (OS 级别的窗口)    | 应用程序的主窗口 |

#+begin_src
+-----------------------------------------------+
| Frame (OS 窗口)                               |
|  +-------------------+----------------------+ |
|  | Window 1          | Window 2             | |
|  | (显示 Buffer A)    | (显示 Buffer B)      | |
|  | def foo():        | * Heading 1          | |
|  |     return 42     |   Some text here...  | |
|  +-------------------+----------------------+ |
|  | Window 3                                 | |
|  | (显示 Buffer C)                           | |
|  | > ls -la                                 | |
|  +------------------------------------------+ |
+-----------------------------------------------+
#+end_src

** Buffer 的生命周期

1. *创建*: 打开文件 (=find-file=) 或手动创建 (=generate-new-buffer=)
2. *编辑*: 修改内容，buffer 的 =modified= 标志变为 =t=
3. *保存*: 写入磁盘 (=save-buffer=)，=modified= 标志清除
4. *关闭*: 杀死 buffer (=kill-buffer=)，释放内存

* Buffer 操作快捷键

** 创建

- =SPC b N= :: 新的空 buffer
- =SPC b c= :: 克隆当前 buffer
- =SPC b C= :: 克隆当前 buffer 到另一个 window

** 切换

- =SPC b [= :: 前一个 buffer
- =SPC b ]= :: 后一个 buffer
- =SPC b X= :: 切换到一开始的 buffer
- =SPC b l= :: 切换到最后的 buffer

** 关闭

- =SPC b k= :: 关闭当前 buffer
- =SPC b d= :: 同上
- =SPC b K= :: 关闭所有 buffers
- =SPC b O= :: 关闭其他所有 buffers

** 保存

- =SPC b s= :: 保存当前 buffer
- =SPC b S= :: 保存所有的 buffers
- =SPC b u= :: 将 buffer 保存为 root

* 扩展: 其他常用 Buffer 操作

** Buffer 列表与搜索

- =SPC b b= :: 在当前 project 中搜索并切换 buffer (使用 Ivy/Vertico/Helm)
- =SPC b B= :: 在所有 buffers 中搜索并切换
- =SPC b i= :: 打开 =ibuffer= (交互式 buffer 列表)
- =SPC ,= :: 快速切换到 project 中最近的 buffer

** Buffer 重命名与克隆

- =SPC b r= :: 重命名当前 buffer
- =SPC b c= :: 克隆 buffer (indirect buffer，共享文本但有独立的 point/narrowing)

** 特殊 Buffers

- =SPC b m= :: 切换到 =*Messages*= buffer (查看 Emacs 消息日志)
- =SPC b s= :: 切换到 =*scratch*= buffer (Lisp 临时计算区)

** Narrowing: 聚焦 Buffer 的一部分

Emacs 的 *narrowing* 功能可以临时 "缩小" buffer 的可见范围:

- =SPC n r= :: Narrow to region (只显示选中的区域)
- =SPC n f= :: Narrow to function (只显示当前函数)
- =SPC n w= :: Widen (恢复完整 buffer 视图)

这在处理大文件或复杂 Org 文档时非常有用。

* Window 操作: 分屏与布局

Doom Emacs 的 Window 管理也非常强大，常用快捷键:

** 分割 Window

- =SPC w v= :: 垂直分割 (左右)
- =SPC w s= :: 水平分割 (上下)
- =SPC w /= :: 同 =SPC w v=
- =SPC w -= :: 同 =SPC w s=

** 导航

- =SPC w h/j/k/l= :: 向左/下/上/右移动光标到相邻 window
- =SPC w w= :: 循环切换 window
- =SPC w W= :: 反向循环切换

** 调整大小

- =SPC w H/J/K/L= :: 向左/下/上/右扩展当前 window
- =SPC w == :: 平衡所有 window 的大小

** 关闭

- =SPC w d= :: 删除当前 window
- =SPC w o= :: 删除其他所有 windows (只保留当前)

* File 操作: 文件管理

** 文件打开与保存

- =SPC .= :: 在当前目录查找文件 (使用 =dired=)
- =SPC SPC= :: 在当前 project 查找文件 (Projectile)
- =SPC f f= :: 同 =SPC .=
- =SPC f r= :: 打开最近文件列表
- =SPC f s= :: 保存当前文件 (同 =:w= 或 =C-x C-s=)
- =SPC f S= :: 另存为

** Dired: 文件浏览器

Doom Emacs 内置了增强的 Dired (Directory Editor):

- =SPC o -= :: 打开 Dired 侧边栏
- =SPC o e= :: 同上
- 在 Dired 中:
  - =RET= :: 打开文件或目录
  - =d= :: 标记删除
  - =x= :: 执行删除
  - =m= :: 标记文件
  - =u= :: 取消标记
  - =C= :: 复制
  - =R= :: 移动/重命名

** 项目管理: Projectile

Projectile 是 Doom Emacs 的项目管理核心:

- =SPC p p= :: 切换项目
- =SPC p f= :: 在项目中查找文件
- =SPC p g= :: 在项目中 grep 搜索
- =SPC p c= :: 编译项目
- =SPC p t= :: 运行项目测试

* Help 系统: 自我探索

Doom Emacs 继承了 Emacs 强大的自省能力:

** 查看文档

- =SPC h f= :: Describe function (查看函数文档)
- =SPC h v= :: Describe variable (查看变量)
- =SPC h k= :: Describe key (查看快捷键绑定)
- =SPC h m= :: Describe mode (查看当前 major/minor modes)

** 跳转到定义

- =SPC h F= :: Find function definition
- =SPC h V= :: Find variable definition

** 搜索配置

- =SPC h d h= :: 打开 Doom 配置帮助
- =SPC h d m= :: 打开 Doom 模块文档

* Evil 核心编辑命令

虽然本文档主要关注 Doom 特定的快捷键，但 Evil 的核心 Vim 命令同样重要:

** 移动

- =h/j/k/l= :: 左/下/上/右移动
- =w/b= :: 向前/向后移动一个单词
- =0/$= :: 行首/行尾
- =gg/G= :: 文件开头/结尾
- =f{char}= :: 跳转到本行下一个 {char}
- =t{char}= :: 跳转到本行下一个 {char} 之前

** 编辑

- =i/a= :: 进入 Insert 模式 (光标前/后)
- =I/A= :: 进入 Insert 模式 (行首/行尾)
- =o/O= :: 新建行并进入 Insert 模式 (下方/上方)
- =d{motion}= :: 删除 (如 =dw=, =dd=, =d$=)
- =c{motion}= :: 修改 (删除后进入 Insert)
- =y{motion}= :: 复制 (yank)
- =p/P= :: 粘贴 (光标后/前)
- =u= :: 撤销 (undo)
- =C-r= :: 重做 (redo)

** Visual 模式

- =v= :: 字符选择
- =V= :: 行选择
- =C-v= :: 块选择 (矩形选择)

** Text Objects

- =iw/aw= :: Inner word / A word (包括空格)
- =i(/a(= :: 括号内 / 包括括号
- =i{/a{= :: 花括号内 / 包括花括号
- =it/at= :: HTML/XML 标签内 / 包括标签
- =ip/ap= :: 段落内 / 段落

示例:

- =diw= :: 删除光标所在单词
- =ci"= :: 修改双引号内的内容
- =ya(= :: 复制括号及其内容
- =dap= :: 删除整个段落

* Evil 的 Doom Emacs 增强

Doom Emacs 对 Evil 做了许多改进:

** Evil Snipe: 增强的 f/t

=s{char}{char}= 可以快速跳转到任意两个字符的组合:

- =sab= :: 跳转到下一个 "ab"
- =Sab= :: 跳转到上一个 "ab"
- =;= :: 重复上次跳转
- =,= :: 反向重复

** Evil Surround: 环绕编辑

- =ys{motion}{char}= :: 添加环绕符号
  - =ysiw"= :: 给单词加双引号
  - =ysap)= :: 给段落加括号
- =cs{old}{new}= :: 修改环绕符号
  - =cs"'= :: 双引号改单引号
- =ds{char}= :: 删除环绕符号
  - =ds"= :: 删除双引号

** Evil Commentary: 注释

- =gc{motion}= :: 注释/取消注释
  - =gcc= :: 注释当前行
  - =gcap= :: 注释段落
- =gC{motion}= :: 块注释

** Evil Lion: 对齐

- =gl{char}= :: 按字符左对齐
- =gL{char}= :: 按字符右对齐

示例:

#+begin_src c
// 原始代码
int x = 1;
int foo = 200;
int bar = 3;

// 选中三行，按 gl=，结果:
int x   = 1;
int foo = 200;
int bar = 3;
#+end_src

* Emacs vs. Vim: 为什么选择 Evil？

** Vim 的优势

- *模态编辑*: 分离浏览和编辑，减少手指移动
- *组合性*: =d{motion}= + =i{text-object}= 的设计非常直观
- *效率*: 少用鼠标，多用键盘
- *普遍性*: Vi/Vim 几乎在所有 Unix 系统上可用

** Emacs 的优势

- *可编程性*: Emacs Lisp 可以定制一切
- *生态系统*: Org-mode, Magit, TRAMP, Gnus, ERC...
- *统一界面*: 文本编辑、邮件、RSS、文档、代码、shell 都在 Emacs 中
- *持久性*: 40 多年的积累，社区成熟

** Evil: 两者的结合

Evil Mode 让你可以:

1. 用 Vim 的方式编辑文本 (高效、直观)
2. 用 Emacs 的方式扩展功能 (强大、灵活)
3. 避免 Vim 的限制 (VimScript, 插件冲突, 启动慢)
4. 避免 Emacs 的陡峭学习曲线 (如果你已经会 Vim)

#+begin_quote
"Emacs is a great operating system, lacking only a decent editor."
— Vim 用户的老梗

"Evil is the solution."
— Doom Emacs 用户
#+end_quote

* 实用技巧与陷阱

** 技巧 1: 快速退出 Insert 模式

默认 =ESC= 或 =C-[= 退出 Insert 模式，但在终端中 =ESC= 可能有延迟。

Doom Emacs 默认启用了 =evil-escape=，可以通过 *快速连按两个键* 退出:

- 默认: =fd= (快速按 f 再按 d)
- 可在 =config.el= 中自定义:

#+begin_src emacs-lisp
(after! evil-escape
  (setq evil-escape-key-sequence "jk"))  ; 改为 jk
#+end_src

** 技巧 2: Buffer 快速跳转

使用 =SPC b b= 后，可以通过 *首字母模糊搜索*:

- 输入 =con= → 跳转到 =config.el=
- 输入 =init= → 跳转到 =init.el=

结合 =ivy=/=vertico= 的智能排序，通常只需 2-3 个字母。

** 技巧 3: 使用 Marks

Vim 的 marks 在 Evil 中同样可用:

- =m{a-z}= :: 设置本地 mark (仅当前 buffer)
- =m{A-Z}= :: 设置全局 mark (跨 buffer)
- ='a= :: 跳转到 mark a 所在行
- =`a= :: 跳转到 mark a 的精确位置

全局 marks 在多文件编辑时非常有用:

#+begin_example
1. 在 main.rs 中按 mM
2. 切换到 lib.rs 编辑
3. 按 'M 立刻回到 main.rs 的位置
#+end_example

** 陷阱 1: C-x 不是 Cut

在 Emacs 中，=C-x= 是 *命令前缀*，不是 Vim 中的 "减 1"。

Doom Emacs 将数字递减绑定到了:

- =C-x= → =evil-numbers/dec-at-pt= (需额外配置)
- 或直接用 Vim 的 =C-a=/=C-x= (如果你配置了)

** 陷阱 2: Y 的行为

Doom Emacs 修改了 =Y= 的行为:

- Vim 默认: =Y= = =yy= (复制整行)
- Doom: =Y= = =y$= (复制到行尾，与 =C=, =D= 一致)

如果你不喜欢，可以恢复:

#+begin_src emacs-lisp
(after! evil
  (evil-define-key 'normal 'global "Y" 'evil-yank-line))
#+end_src

** 陷阱 3: Buffer 不等于文件

记住:

- 关闭 buffer (=SPC b k=) *不会删除文件*，只是关闭内存中的副本
- 关闭所有 buffers (=SPC b K=) 不会退出 Emacs
- 保存 buffer (=SPC b s=) 才会写入磁盘

初学者常误以为 "关闭 buffer = 关闭文件"，导致困惑。

* 总结: 从 Vim 到 Doom Emacs

如果你是 Vim 用户，迁移到 Doom Emacs 的路径:

1. *第 1 周*: 学会基本的 buffer 操作 (=SPC b=) 和文件操作 (=SPC f=)
2. *第 2 周*: 掌握 window 管理 (=SPC w=) 和 project 导航 (=SPC p=)
3. *第 3 周*: 探索 Org-mode (=SPC m=) 和 Magit (=SPC g=)
4. *第 4 周*: 开始定制 =config.el=，添加你的个性化配置

核心原则:

- *不要急于定制*: Doom 的默认配置已经很好，先用熟再改
- *善用 Help 系统*: =SPC h k= 是你的朋友
- *查阅文档*: [[https://docs.doomemacs.org]] 和 =SPC h d h=
- *拥抱 Emacs Lisp*: 如果你想深度定制，学习 Elisp 是必须的

#+begin_quote
"The best editor is neither Emacs nor Vim, but Emacs *pretending* to be Vim."
— Anonymous Doom Emacs user
#+end_quote

* 参考资源

- [[https://github.com/doomemacs/doomemacs][Doom Emacs GitHub Repository]]
- [[https://docs.doomemacs.org][Doom Emacs Official Documentation]]
- [[https://github.com/emacs-evil/evil][Evil Mode GitHub Repository]]
- [[https://github.com/emacs-evil/evil-collection][Evil Collection: 为各种 Emacs modes 提供 Evil 绑定]]
- [[https://www.gnu.org/software/emacs/manual/html_node/emacs/Buffers.html][GNU Emacs Manual: Buffers]]
- [[https://www.masteringemacs.org/article/why-emacs-has-buffers][Mastering Emacs: Why Emacs has Buffers]]
